{% extends "base.html" %}
{% block title %}Trade Stocks{% endblock %}
{% block content %}

<div class="row mb-4">
  <div class="col-lg-8">
    <h1 class="fw-bold">Trade Stocks</h1>
    <p class="lead text-muted">Buy or sell stocks from your portfolio.</p>
    <div class="user-info mb-3">
      <p><strong>Available Cash:</strong> ${{ "%.2f"|format(cash_balance) }}</p>
    </div>
  </div>
</div>

<!-- üîî Market Status Alert -->
{% if not market_is_open %}
  <div class="alert alert-danger text-center fs-5">
    üö´ Transaction Failed: The Market is Currently Closed.<br>
    You can trade only between 
    <strong>{{ market.open_time.strftime('%H:%M') if market else 'N/A' }}</strong> 
    and 
    <strong>{{ market.close_time.strftime('%H:%M') if market else 'N/A' }}</strong>.
  </div>
{% else %}
  <div class="alert alert-success text-center fs-5">
    üü¢ Market is Open ‚Äî Trading is Active!
  </div>
{% endif %}

<!-- üì® Message from Server -->
{% if message %}
  <div class="alert alert-info text-center">{{ message }}</div>
{% endif %}

<!-- üìä Stock Price Chart Section -->
<div class="card shadow-sm mb-5">
  <div class="card-header bg-dark text-white">
    <h5 class="mb-0">Available Stocks Overview</h5>
  </div>
  <div class="card-body">
    <canvas id="stockChart" height="120"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('stockChart').getContext('2d');
  const stockChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [{% for stock in stocks %}'{{ stock.ticker }}',{% endfor %}],
      datasets: [
        {
          label: 'Opening Price ($)',
          data: [{% for stock in stocks %}{{ opening_prices[stock.id] }},{% endfor %}],
          backgroundColor: 'rgba(255, 206, 86, 0.6)',
          borderColor: 'rgba(255, 206, 86, 1)',
          borderWidth: 1
        },
        {
          label: 'Current Price ($)',
          data: [{% for stock in stocks %}{{ display_prices[stock.id] }},{% endfor %}],
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: 'Opening vs Current Market Prices' }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Price ($)' }
        },
        x: {
          title: { display: true, text: 'Ticker Symbol' }
        }
      }
    }
  });
</script>

<!-- Opening vs Current Price Table -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-secondary text-white">
    <h5 class="mb-0">Stock Opening and Current Prices</h5>
  </div>
  <div class="card-body">
    <table class="table table-striped table-bordered text-center">
      <thead class="table-dark">
        <tr>
          <th>Company</th>
          <th>Ticker</th>
          <th>Opening Price ($)</th>
          <th>Current Price ($)</th>
        </tr>
      </thead>
      <tbody>
        {% for stock in stocks %}
        <tr>
          <td>{{ stock.company_name }}</td>
          <td>{{ stock.ticker }}</td>
          <td>${{ "%.2f"|format(opening_prices[stock.id]) }}</td>
          <td>${{ "%.2f"|format(display_prices[stock.id]) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- High / Low Table -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-secondary text-white">
    <h5 class="mb-0">Stock Market Highs and Lows</h5>
  </div>
  <div class="card-body">
    <table class="table table-striped table-bordered text-center">
      <thead class="table-dark">
        <tr>
          <th>Company</th>
          <th>Ticker</th>
          <th>High ($)</th>
          <th>Low ($)</th>
        </tr>
      </thead>
      <tbody>
        {% for stock in stocks %}
        <tr>
          <td>{{ stock.company_name }}</td>
          <td>{{ stock.ticker }}</td>
          <td class="text-success fw-bold">${{ "%.2f"|format(stock.high_price) }}</td>
          <td class="text-danger fw-bold">${{ "%.2f"|format(stock.low_price) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<!-- Buy/Sell Stocks Section -->
<div class="row">
  <!-- Buy Stocks Section -->
  <div class="col-md-6">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Buy Stocks</h5>
      </div>
      <div class="card-body">
        {% if not market_is_open %}
          <div class="alert alert-warning">‚ö†Ô∏è Trading is disabled while the market is closed.</div>
        {% else %}
          <form method="POST">
            <input type="hidden" name="action" value="buy">
            <div class="mb-3">
              <label for="stock_id_buy" class="form-label">Select Stock</label>
              <select name="stock_id" id="stock_id_buy" class="form-select" required>
                {% for stock in stocks %}
                <option value="{{ stock.id }}">
                  {{ stock.company_name }} ({{ stock.ticker }}) - ${{ display_prices[stock.id] }} - Available: {{ stock.volume }} shares
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="quantity_buy" class="form-label">Quantity</label>
              <input type="number" name="quantity" id="quantity_buy" class="form-control" min="1" required>
            </div>
            <button type="submit" class="btn btn-primary" onclick="return confirm('Are you sure you want to buy this stock?')">Buy</button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Sell Stocks Section -->
  <div class="col-md-6">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Sell Stocks</h5>
      </div>
      <div class="card-body">
        {% if not market_is_open %}
          <div class="alert alert-warning">‚ö†Ô∏è Trading is disabled while the market is closed.</div>
        {% else %}
          <form method="POST">
            <input type="hidden" name="action" value="sell">
            <div class="mb-3">
              <label for="stock_id_sell" class="form-label">Select Stock</label>
              <select name="stock_id" id="stock_id_sell" class="form-select" required>
                {% for item in portfolio %}
                <option value="{{ item.stock.id }}">
                  {{ item.stock.company_name }} ({{ item.stock.ticker }}) - Owned: {{ item.quantity }} shares - Price: ${{ display_prices[item.stock.id] }} - Market Volume: {{ item.stock.volume }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="quantity_sell" class="form-label">Quantity</label>
              <input type="number" name="quantity" id="quantity_sell" class="form-control" min="1" required>
            </div>
            <button type="submit" class="btn btn-primary" onclick="return confirm('Are you sure you want to sell this stock?')">Sell</button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
